<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Panel | Demo Name</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  video.bg-video {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
  }
</style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

<!-- Background Video -->
<video autoplay loop muted playsinline class="bg-video">
  <source src="videos/hero.mp4" type="video/mp4" />
</video>

<header class="sticky top-0 bg-black/70 backdrop-blur-md p-4 border-b border-gray-800 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-pink-500">Admin Panel</h1>
  <button onclick="window.location.href='/'" class="bg-pink-500 hover:bg-pink-600 px-4 py-2 rounded font-bold">← Go Back</button>
</header>

<main class="max-w-xl mx-auto p-6 mt-6 flex flex-col gap-8 bg-black/40 backdrop-blur-md rounded-xl">

  <!-- Login Section -->
  <section id="login-section" class="bg-gray-800/80 p-6 rounded-lg shadow-lg">
    <h2 class="text-xl font-bold text-pink-500 mb-4">Admin Login</h2>
    <form id="login-form" class="flex flex-col gap-4">
      <input type="email" id="login-email" placeholder="Email" class="p-2 rounded bg-gray-700 border border-gray-600" required>
      <input type="password" id="login-password" placeholder="Password" class="p-2 rounded bg-gray-700 border border-gray-600" required>
      <button type="submit" class="bg-pink-500 hover:bg-pink-600 py-2 rounded font-bold">Login</button>
      <p id="login-error" class="text-red-400 hidden"></p>
    </form>
  </section>

  <!-- Create Project -->
  <section id="project-section" class="bg-gray-800/80 p-6 rounded-lg shadow-lg hidden">
    <h2 class="text-xl font-bold text-pink-500 mb-4">Create New Project</h2>
    <form id="create-project-form" class="flex flex-col gap-4">
      <input type="text" id="project-name" placeholder="Project Name" class="p-2 rounded bg-gray-700 border border-gray-600" required>
      <textarea id="project-desc" placeholder="Project Description" rows="4" class="p-2 rounded bg-gray-700 border border-gray-600" required></textarea>
      <button type="submit" class="bg-pink-500 hover:bg-pink-600 py-2 rounded font-bold">Create Project</button>
      <p id="project-create-success" class="text-green-400 hidden">✅ Project created!</p>
    </form>
  </section>

  <!-- Add Media -->
  <section id="media-section" class="bg-gray-800/80 p-6 rounded-lg shadow-lg hidden">
    <h2 class="text-xl font-bold text-pink-500 mb-4">Add Images / Videos</h2>
    <form id="add-media-form" class="flex flex-col gap-4">
      <select id="select-project" class="p-2 rounded bg-gray-700 border border-gray-600" required>
        <option value="">Select Project</option>
      </select>
      <input type="file" id="media-file" accept="image/*,video/*" class="p-2 rounded bg-gray-700 border border-gray-600" required>
      <button type="submit" class="bg-pink-500 hover:bg-pink-600 py-2 rounded font-bold">Upload Media</button>
      <p id="media-success" class="text-green-400 hidden">✅ Media uploaded!</p>
    </form>
  </section>

  <!-- Manage Projects & Media -->
  <section id="manage-section" class="bg-gray-800/80 p-6 rounded-lg shadow-lg hidden">
    <h2 class="text-xl font-bold text-pink-500 mb-4">Manage Projects & Media</h2>
    <div id="project-list" class="flex flex-col gap-2"></div>
    <div id="media-list" class="flex flex-col gap-4 mt-4"></div>
  </section>

</main>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://jprslkrxccjefudlismu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwcnNsa3J4Y2NqZWZ1ZGxpc211Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NjY1MzAsImV4cCI6MjA3NTQ0MjUzMH0.LuMD06T2NTE2G7AEcynCKPUboulhybm6l4YKjCFpCyo";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const loginSection = document.getElementById("login-section");
const projectSection = document.getElementById("project-section");
const mediaSection = document.getElementById("media-section");
const manageSection = document.getElementById("manage-section");
const projectList = document.getElementById("project-list");
const mediaList = document.getElementById("media-list");
let currentUser = null;

// --- Login ---
document.getElementById("login-form").addEventListener("submit", async e => {
  e.preventDefault();
  const email = document.getElementById("login-email").value;
  const password = document.getElementById("login-password").value;

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) {
    document.getElementById("login-error").textContent = error.message;
    document.getElementById("login-error").classList.remove("hidden");
    return;
  }

  currentUser = data.user;
  loginSection.style.display = "none";
  projectSection.classList.remove("hidden");
  mediaSection.classList.remove("hidden");
  manageSection.classList.remove("hidden");

  loadProjectsDropdown();
  loadProjectsList();
  loadMediaList();
});

// --- Create Project ---
document.getElementById("create-project-form").addEventListener("submit", async e => {
  e.preventDefault();
  const name = document.getElementById("project-name").value.trim();
  const description = document.getElementById("project-desc").value.trim();
  if (!name || !description) return alert("Please fill in all fields.");

  const { error } = await supabase.from("projects").insert([{ name, description, created_at: new Date().toISOString(), owner_id: currentUser.id }]);
  if (error) return alert("Error creating project: " + error.message);

  document.getElementById("create-project-form").reset();
  document.getElementById("project-create-success").classList.remove("hidden");
  setTimeout(() => document.getElementById("project-create-success").classList.add("hidden"), 3000);

  loadProjectsDropdown();
  loadProjectsList();
});

// --- Load Projects Dropdown ---
const selectProject = document.getElementById("select-project");
async function loadProjectsDropdown() {
  const { data: projects, error } = await supabase.from("projects").select("id, name").order("created_at", { ascending: false });
  if (error) return console.error(error);

  selectProject.innerHTML = '<option value="">Select Project</option>';
  projects?.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.name;
    selectProject.appendChild(opt);
  });
}

// --- Add Media ---
document.getElementById("add-media-form").addEventListener("submit", async e => {
  e.preventDefault();
  const projectId = selectProject.value;
  const fileInput = document.getElementById("media-file");
  if (!projectId || fileInput.files.length === 0) return alert("Select a project and a media file.");

  const file = fileInput.files[0];
  const fileExt = file.name.split(".").pop();
  const filePath = `projects/${projectId}/${Date.now()}.${fileExt}`;

  const { error: uploadError } = await supabase.storage.from("media").upload(filePath, file, { upsert: true });
  if (uploadError) return alert("Upload error: " + uploadError.message);

  const { data: publicData } = supabase.storage.from("media").getPublicUrl(filePath);
  const url = publicData.publicUrl;

  const type = file.type.startsWith("video/") ? "video" : "image";

  const { error: dbError } = await supabase.from("media").insert([{
    project_id: projectId,
    url,
    file_path: filePath,
    type,
    created_at: new Date().toISOString(),
    owner_id: currentUser.id
  }]);
  if (dbError) return alert("DB error: " + dbError.message);

  document.getElementById("add-media-form").reset();
  document.getElementById("media-success").classList.remove("hidden");
  setTimeout(() => document.getElementById("media-success").classList.add("hidden"), 3000);

  loadMediaList();
});

// --- Manage Projects ---
async function loadProjectsList() {
  const { data: projects, error } = await supabase.from("projects").select("*").order("created_at", { ascending: false });
  if (error) return console.error(error);

  projectList.innerHTML = "";
  projects.forEach(p => {
    const div = document.createElement("div");
    div.className = "flex justify-between items-center p-2 bg-gray-700 rounded";
    div.innerHTML = `
      <span>${p.name}</span>
      <div class="flex gap-2">
        <button class="bg-yellow-500 px-2 rounded edit-project">Edit</button>
        <button class="bg-red-500 px-2 rounded delete-project">Delete</button>
      </div>
    `;
    projectList.appendChild(div);

    div.querySelector(".edit-project").addEventListener("click", async () => {
      const newName = prompt("Edit project name:", p.name);
      const newDesc = prompt("Edit description:", p.description);
      if (!newName || !newDesc) return;
      const { error } = await supabase.from("projects").update({ name: newName, description: newDesc }).eq("id", p.id);
      if (error) return alert("Error updating project: " + error.message);
      loadProjectsList();
      loadProjectsDropdown();
    });

    div.querySelector(".delete-project").addEventListener("click", async () => {
      if (!confirm("Delete this project? This will also delete associated media.")) return;

      const { data: mediaData } = await supabase.from("media").select("*").eq("project_id", p.id);
      for (const m of mediaData) {
        if (m.file_path) await supabase.storage.from("media").remove([m.file_path]);
      }

      const { error } = await supabase.from("projects").delete().eq("id", p.id);
      if (error) return alert("Error deleting project: " + error.message);

      loadProjectsList();
      loadProjectsDropdown();
      loadMediaList();
    });
  });
}

// --- Manage Media ---
async function loadMediaList() {
  const { data: media, error } = await supabase.from("media").select("*").order("created_at", { ascending: false });
  if (error) return console.error(error);

  mediaList.innerHTML = "";
  media.forEach(m => {
    const div = document.createElement("div");
    div.className = "flex flex-col p-2 bg-gray-700 rounded gap-2";

    let preview = m.type === "image"
      ? `<img src="${m.url}" class="max-h-40 rounded"/>`
      : `<video src="${m.url}" controls class="max-h-40 rounded"></video>`;

    div.innerHTML = `
      <div class="flex justify-between items-center">
        <span>${m.type}: ${m.url.split("/").pop()}</span>
        <button class="bg-red-500 px-2 rounded delete-media">Delete</button>
      </div>
      ${preview}
    `;
    mediaList.appendChild(div);

    div.querySelector(".delete-media").addEventListener("click", async () => {
      if (!confirm("Delete this media?")) return;

      const fileKey = m.file_path;
      if (!fileKey) return alert("File path missing, cannot delete.");

      const { error: storageError } = await supabase.storage.from("media").remove([fileKey]);
      if (storageError) return alert("Error deleting file from storage: " + storageError.message);

      const { error: dbError } = await supabase.from("media").delete().eq("id", m.id);
      if (dbError) return alert("Error deleting media from DB: " + dbError.message);

      loadMediaList();
    });
  });
}
</script>

</body>
</html>
